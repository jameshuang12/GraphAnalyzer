from datetime import datetime
import stock_class
import confirm_input
import numpy as np


def main():
    user_data = confirm_input.userInput()

    clientData = stock_class.Stock(user_data[0], user_data[1], user_data[2])
    per_change = percentageChange(clientData)


    #will need to clean this up, works but the ordering is wack
    while True:
        if len(clientData) >= 10:
            answer = str(input("Would you like to run a Relative Strength Index calculation? (y/n): "))
            if answer in ('y', 'n'):
                if answer == 'y':
                    rsi_function(clientData)
                    continue
                else:
                    while True:
                        investment(clientData, per_change)
                        answer = str(input('Would you like to run again for this stock? (y/n): '))
                        if answer == 'y':
                            continue
                        elif answer == 'n':
                            print("Goodbye")
                            break
                        else:
                            print("invalid input.")
                    break
            print("invalid input.")


def percentageChange(clientData):
    """ Get the percentage change of the two dates given by the user.

    :param clientData: All the data needed from the given dates
    :return: the percent change between the first to the second
    """
    print('For the first date')
    data1 = askUserForData(clientData)
    print('For the second date')
    data2 = askUserForData(clientData)

    first_call = getattr(clientData, str(data1))
    sec_call = getattr(clientData, str(data2))

    change = int((sec_call[-1] / first_call[0]) * 100)

    if change < 100:
        print('The percentage change had a decline of ' + str(change) + '%')
    else:
        print('The percentage change had a growth of ' + str(change) + '%')

    return change


def askUserForData(clientData):
    """ Ask the user for the specific data they want to provided by the stock market

    :param yourmom: All the data needed from the given dates
    :return: the data the user wants to use
    """
    print('Please choose from the options below you would like to use')
    print('1. open, 2. high, 3. low, 4. close')
    data = str(input('Enter the data here: '))

    while data != ('high') and data != ('open') and data != ('low') and data != ('close'):
        data = str(input('Incorrect input, options are open, high , low, close: '))

    return data


def rsi_function(clientData):
    gaincounter = 0
    losscounter = 0
    gain = 0
    loss = 0

    for i in range(9, 0, -1):
        if clientData.close[-i] < clientData.close[-i - 1]:
            gaincounter += 1
            gain += clientData.close[-i - 1] - clientData.close[-i]
        else:
            losscounter += 1
            loss += abs(clientData.close[-i] - clientData.close[-i - 1])

    avg_gain = gain / gaincounter

    avg_loss = loss / losscounter

    rsi = 100 - 100 / (1 + (avg_gain / avg_loss))

    print(rsi)

    if rsi > 70.000:
        print("The RSI index is " + str(rsi) + ", meaning the stock is currently being overbought"
                                          " and the stock will have a bearish trend in the near future."
                                          " It is strongly not recommended to buy the stock now.")
    elif 70.000 > rsi > 50.000:
        print("The RSI index is " + str(rsi) + ", meaning the stock is being bought more than it is being sold."
                                          " Buying the stock today is encouraged as it is following a "
                                          "bullish trend but it is recommended to either hold for long term or"
                                          "sell it in the near future")

    elif 50.00 > rsi > 30.000:
        print("The RSI index is " + str(rsi) + ", meaning the stock is being sold more than it is being bought."
                                          " Buying the stock today is not encouraged as it following a bearish"
                                          " trend but is recommended to buy later")
    else:
        print("The RSI index is " + str(rsi) + ", meaning the stock is currently being oversold and the stock will"
                                          " have a bullish trend in the near future. It is strongly recommended"
                                          " to buy the stock now")

def should_i_buy():
    """
    :param: rsi function value, ADX function value, moving average value(Calculation TBD)
    :return: statement that will tell user whether to buy stock or not based on the three indicating factors
    """
    return 1


def investment(clientData, percent_change):
    """ Calcualates the investment amount for the user

    :param clientData: All the data needed from the given dates
    :return: the amount gained or lost
    """

    while True:
        amount = str(input('Enter the amount you would like to invest: $'))
        if not amount.isdigit():
            print('Invalid input (requires numeric amount)')
            continue
        else:
            amount = int(amount)
            break

    investmentAmount = int(amount * (percentageChange(clientData) / 100))

    if investmentAmount < amount:
        total = int(amount - investmentAmount)
        print('If you invested on ' + str(clientData.day1) + ' with the amount of $' + str(amount) + ' ,then you'
                                                                                                     " would've lost $" + str(
            total) + " if you withdraw on " + str(clientData.day2) + ".")
    else:
        total = investmentAmount - amount
        print('If you invested on ' + str(clientData.day1) + ' with the amount of $' + str(amount) + ' ,then you'
                                                                                                     " would've gained $" + str(
            total) + " if you withdraw on " + str(clientData.day2) + ".")


if __name__ == '__main__':
    main()
